
<!-- Notes on selections:
      - just need to remove deselected row from grid when not in brushed range
            note that pc.brushed and pc.selected are identitcal at start of onSelectedRowsChanged
      - is perserveHidden relevant here?
 -->


<!doctype html>

<title>Testbed Version 2</title>

<!-- SlickGrid -->
<link rel="stylesheet" href="lib/slickgrid/slick.grid.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/plugins/slick.columnpicker.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/jquery-ui-1.8.16.custom.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/examples.css" type="text/css"/>
<!-- Remove pager
<link rel="stylesheet" href="lib/slickgrid/slick.pager.css" type="text/css"/>
<script src="lib/slickgrid/slick.pager.js"></script>
-->
<script src="lib/slickgrid/jquery-1.7.min.js"></script>
<script src="lib/slickgrid/jquery.event.drag-2.0.min.js"></script>
<script src="lib/slickgrid/slick.core.js"></script>
<script src="lib/slickgrid/slick.grid.js"></script>
<script src="lib/slickgrid/slick.dataview.js"></script>

<script src="lib/slickgrid/plugins/slick.checkboxselectcolumn.js"></script>
<script src="lib/slickgrid/plugins/slick.autotooltips.js"></script>
<script src="lib/slickgrid/plugins/slick.cellrangedecorator.js"></script>
<script src="lib/slickgrid/plugins/slick.cellrangeselector.js"></script>
<script src="lib/slickgrid/plugins/slick.cellcopymanager.js"></script>
<script src="lib/slickgrid/plugins/slick.cellselectionmodel.js"></script>
<script src="lib/slickgrid/plugins/slick.rowselectionmodel.js"></script>
<script src="lib/slickgrid/plugins/slick.columnpicker.js"></script>
<script src="lib/slickgrid/slick.formatters.js"></script>
<script src="lib/slickgrid/slick.editors.js"></script>
<!-- End SlickGrid -->

<link rel="stylesheet" type="text/css" href="../d3.parcoords.css">
<link rel="stylesheet" type="text/css" href="style.css">
<style>
/* white text shadow on ticks */
svg {
  font: 10px sans-serif;
}
.axis text {
  text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
  cursor: move;
}

body, html {
  margin: 0;
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-size: 12px;
}
#grid /* , #pager*/ {
  position: fixed;
  width: 100%;
}
#grid {
  left: 30px;
  bottom: 10px;
  height: 290px;
}
.slick-row:hover {
  background: #ddd;
}
.slick-cell-checkboxsel {
      background: #f0f0f0;
      border-right-color: silver;
      border-right-style: solid;
}
</style>
<script src="lib/d3.min.js"></script>
<script src="../d3.parcoords.js"></script>
<script src="lib/divgrid.js"></script>
<script src="lib/underscore.js"></script>
<input type="file" id="uploader">
<button id="selections-reset">Reset Selections</button>



<body>
<div id="example" class="parcoords" style="height:240px;"></div>
<div id="grid"></div>
<!--
<div id="pager"></div>
-->
<script>
var parcoords = d3.parcoords()("#example")
  .alpha(0.4)
  .mode("queue") // progressive rendering
  .height(d3.max([document.body.clientHeight-326, 220]))
  .margin({
    top: 36,
    left: 100,
    right: 100,
    bottom: 16
  });

// create chart from loaded data
function parallelCoordinates(data) {
  // slickgrid needs each data element to have an id
  data.forEach(function(d,i) { d.id = d.id || i; });

  parcoords
    .data(data)
    .hideAxis(["name"]) // it would be nice to find a general way to do this
    .render()
    .shadows()
    .reorderable()
    .brushMode("1D-axes");

  // setting up grid
  var column_keys = d3.keys(data[0]).slice(0,-1); //remove id col
  var columns = column_keys.map(function(key,i) {
    return {
      id: key,
      name: key,
      field: key,
      sortable: true
    }
  });

  var options = {
    enableCellNavigation: true,
    enableColumnReorder: false,
    multiColumnSort: false,
    editable: true,
    asyncEditorLoading: false,
    autoEdit: false
  };

  var checkboxSelector = new Slick.CheckboxSelectColumn({
    cssClass: "slick-cell-checkboxsel"
  });

  columns.unshift(checkboxSelector.getColumnDefinition());

  var dataView = new Slick.Data.DataView();
  var grid = new Slick.Grid("#grid", dataView, columns, options);
  grid.setSelectionModel(new Slick.RowSelectionModel({selectActiveRow: false}));
  grid.registerPlugin(checkboxSelector);
  //var pager = new Slick.Controls.Pager(dataView, grid, $("#pager"));
  //var columnpicker = new Slick.Controls.ColumnPicker(columns, grid, options);

  // wire up model events to drive the grid
  dataView.onRowCountChanged.subscribe(function (e, args) {
    grid.updateRowCount();
    grid.render();
  });

  dataView.onRowsChanged.subscribe(function (e, args) {
    grid.invalidateRows(args.rows);
    grid.render();
  });

  dataView.syncGridSelection(grid, preserveHidden=false); //vs true

  // column sorting
  var sortcol = column_keys[0];
  var sortdir = 1;

  function comparer(a, b) {
    var x = a[sortcol], y = b[sortcol];
    return (x == y ? 0 : (x > y ? 1 : -1));
  }

  // click header to sort grid column
  grid.onSort.subscribe(function (e, args) {
    sortdir = args.sortAsc ? 1 : -1;
    sortcol = args.sortCol.field;

    if ($.browser.msie && $.browser.version <= 8) {
      dataView.fastSort(sortcol, args.sortAsc);
    } else {
      dataView.sort(comparer, args.sortAsc);
    }
  });

  // highlight row in chart
  grid.onMouseEnter.subscribe(function(e,args) {
    var i = grid.getCellFromEvent(e).row;
    var d = parcoords.brushed() || data;
    parcoords.highlight([d[i]]);
  });

  grid.onMouseLeave.subscribe(function(e,args) {
    parcoords.unhighlight();
  });

  grid.onSelectedRowsChanged.subscribe(function (e, args) {
    // reset and update selected rows

    // console.log("start");
    // console.log("brushed:", parcoords.brushed())
    // console.log("selected:", parcoords.selected())
    // core functionality
    // ---------------------------------------------------------------------
    var selected_row_ids = grid.getSelectedRows();
    var d = parcoords.brushed() || data;

    parcoords.deselect();
    selected_row_ids.forEach(function(i) { parcoords.select([d[i]]); });
    // ---------------------------------------------------------------------
    // console.log("brushed:", parcoords.brushed())
    // console.log("selected:", parcoords.selected())
    // console.log("end");
    /*
    if (parcoords.brushed().length) {
      //var brushed = _.without(parcoords.brushed(), parcoords.selected());
      gridUpdate(parcoords.brushed());
    } else {
      gridUpdate(data);
    }
    */

    /*
    if row unselected and not in brushed data
        remove from grid
        remove from plot
    else if row unselected and in brushed data
        simply deselect
    if row newly selected
        select row
    */
    //brushed = _.difference(parcoords.selected(), parcoords.brushed());
    //console.log(brushed.length)
    //console.log(selected_row_ids.length)
    /*
    console.log("start")
    var last_selected = parcoords.selected(); //equivalent to parcoords.brushed()
    console.log(last_selected)
    var selected_row_ids = grid.getSelectedRows();
    console.log(selected_row_ids)
    var d = parcoords.brushed() || data;
    console.log(d)

    var diff01 = _.difference(last_selected, parcoords.brushed());
    console.log("diff 1:", diff02)

    parcoords.deselect();
    selected_row_ids.forEach(function(i) { parcoords.select([d[i]]); });
    console.log(parcoords.selected())

    var diff02 = _.difference(parcoords.selected(), parcoords.brushed());

    // brushed and not selected
    //var flags = _.difference(parcoords.brushed(), parcoords.selected());
    console.log("diff 2:", diff02)
    console.log("end")

    var brushed = [];
    if (parcoords.brushed().length) {
      brushed = _.difference(parcoords.brushed(), parcoords.selected());
    } else {
      brushed = data;
    }
    */
    //parcoords.render();
    //gridUpdate(brushed);

  });


  // fill grid with data
  gridUpdate(data);

  // update grid on brush
  parcoords.on("brushend", function(d) {
    gridUpdate(d);
  });

  function gridUpdate(data) {
    dataView.beginUpdate();
    dataView.setItems(data);
    // if selected data exists, keep in grid
    if (parcoords.selected().length) {
      parcoords.selected().forEach(function(i) { dataView.insertItem(0,i); });
    }
    dataView.endUpdate();
  };

  // reset selected layer
  d3.select('#selections-reset').on('click', function() {
    // deselect all elements in grid (fires event)
    grid.setSelectedRows([]);
  });

};

// CSV Uploader
var uploader = document.getElementById("uploader");
var reader = new FileReader();

reader.onload = function(e) {
  var contents = e.target.result;
  var data = d3.csv.parse(contents);
  parallelCoordinates(data);

  // remove button, since re-initializing doesn't work for now
  uploader.parentNode.removeChild(uploader);
};

uploader.addEventListener("change", handleFiles, false);

function handleFiles() {
  var file = this.files[0];
  reader.readAsText(file);
};

</script>
</body><html>
